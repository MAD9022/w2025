<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>3.2 Service Worker Events | MAD9022</title>
    <meta name="generator" content="VuePress 1.9.8">
    <link rel="icon" type="image/svg" href="/w2025/assets/javascript.svg">
    <link rel="shortcut icon" type="image/svg" href="/w2025/assets/javascript.svg">
    <meta name="description" content="Fullstack: Frontend Development Course">
    
    <link rel="preload" href="/w2025/assets/css/0.styles.33415ee0.css" as="style"><link rel="preload" href="/w2025/assets/js/app.87c858a9.js" as="script"><link rel="preload" href="/w2025/assets/js/2.ccdb61a5.js" as="script"><link rel="preload" href="/w2025/assets/js/35.ab1290f2.js" as="script"><link rel="preload" href="/w2025/assets/js/9.01890ce5.js" as="script"><link rel="preload" href="/w2025/assets/js/11.5fe5a40b.js" as="script"><link rel="prefetch" href="/w2025/assets/js/10.3e691a48.js"><link rel="prefetch" href="/w2025/assets/js/12.f49551e7.js"><link rel="prefetch" href="/w2025/assets/js/13.d5974a84.js"><link rel="prefetch" href="/w2025/assets/js/14.32f7e6e8.js"><link rel="prefetch" href="/w2025/assets/js/15.0ae027c8.js"><link rel="prefetch" href="/w2025/assets/js/16.f2386a1e.js"><link rel="prefetch" href="/w2025/assets/js/17.d7b9d534.js"><link rel="prefetch" href="/w2025/assets/js/18.7c15b945.js"><link rel="prefetch" href="/w2025/assets/js/19.51980183.js"><link rel="prefetch" href="/w2025/assets/js/20.d519c082.js"><link rel="prefetch" href="/w2025/assets/js/21.362f6b8c.js"><link rel="prefetch" href="/w2025/assets/js/22.afaf2123.js"><link rel="prefetch" href="/w2025/assets/js/23.cdc2c887.js"><link rel="prefetch" href="/w2025/assets/js/24.9b75b7c6.js"><link rel="prefetch" href="/w2025/assets/js/25.e357a328.js"><link rel="prefetch" href="/w2025/assets/js/26.6e814142.js"><link rel="prefetch" href="/w2025/assets/js/27.106c07bd.js"><link rel="prefetch" href="/w2025/assets/js/28.126c37bf.js"><link rel="prefetch" href="/w2025/assets/js/29.ca946c51.js"><link rel="prefetch" href="/w2025/assets/js/3.05989ff3.js"><link rel="prefetch" href="/w2025/assets/js/30.2ba498f6.js"><link rel="prefetch" href="/w2025/assets/js/31.e41d2241.js"><link rel="prefetch" href="/w2025/assets/js/32.cfce5625.js"><link rel="prefetch" href="/w2025/assets/js/33.3dc1268c.js"><link rel="prefetch" href="/w2025/assets/js/34.a3793153.js"><link rel="prefetch" href="/w2025/assets/js/36.3d9064e0.js"><link rel="prefetch" href="/w2025/assets/js/37.2ae4164b.js"><link rel="prefetch" href="/w2025/assets/js/38.195bef2c.js"><link rel="prefetch" href="/w2025/assets/js/39.a9904a96.js"><link rel="prefetch" href="/w2025/assets/js/4.79533d7f.js"><link rel="prefetch" href="/w2025/assets/js/40.1c93503b.js"><link rel="prefetch" href="/w2025/assets/js/41.61991e2b.js"><link rel="prefetch" href="/w2025/assets/js/42.87d5cabf.js"><link rel="prefetch" href="/w2025/assets/js/43.d8a479ef.js"><link rel="prefetch" href="/w2025/assets/js/44.8446907e.js"><link rel="prefetch" href="/w2025/assets/js/45.d1e73d03.js"><link rel="prefetch" href="/w2025/assets/js/46.14dd0c4d.js"><link rel="prefetch" href="/w2025/assets/js/47.6eae941d.js"><link rel="prefetch" href="/w2025/assets/js/48.4b257292.js"><link rel="prefetch" href="/w2025/assets/js/49.7c622f43.js"><link rel="prefetch" href="/w2025/assets/js/5.60adfd1c.js"><link rel="prefetch" href="/w2025/assets/js/50.5cc4788b.js"><link rel="prefetch" href="/w2025/assets/js/51.345ce69e.js"><link rel="prefetch" href="/w2025/assets/js/52.59f792c0.js"><link rel="prefetch" href="/w2025/assets/js/53.9344eea4.js"><link rel="prefetch" href="/w2025/assets/js/6.96402398.js"><link rel="prefetch" href="/w2025/assets/js/7.956989e6.js"><link rel="prefetch" href="/w2025/assets/js/8.62f5a92b.js">
    <link rel="stylesheet" href="/w2025/assets/css/0.styles.33415ee0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/w2025/" class="home-link router-link-active"><img src="/w2025/mad-d-logo-sm.png" alt="MAD9022" class="logo"> <span class="site-name can-hide">MAD9022</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/w2025/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/w2025/assignments/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/w2025/resources/" class="nav-link">
  Resources
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/w2025/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/w2025/assignments/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/w2025/resources/" class="nav-link">
  Resources
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Hybrid</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>PWA</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/w2025/modules/pwas/week1/1.1/" class="sidebar-link">1.1: Course Intro &amp; Review</a></li><li><a href="/w2025/modules/pwas/week1/1.2/" class="sidebar-link">1.2: Review Topics</a></li><li><a href="/w2025/modules/pwas/week2/2.1/" class="sidebar-link">2.1: Single Page Applications</a></li><li><a href="/w2025/modules/pwas/week2/2.2/" class="sidebar-link">2.2: SPA &amp; Coding Practices</a></li><li><a href="/w2025/modules/pwas/week3/3.1/" class="sidebar-link">3.1: Workers &amp; Service Workers</a></li><li><a href="/w2025/modules/pwas/week3/3.2/" aria-current="page" class="active sidebar-link">3.2: Service Worker Events</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/w2025/modules/pwas/week3/3.2/#fetch-api-and-service-workers" class="sidebar-link">Fetch API And Service Workers</a></li><li class="sidebar-sub-header"><a href="/w2025/modules/pwas/week3/3.2/#caches-and-service-workers" class="sidebar-link">Caches and Service Workers</a></li><li class="sidebar-sub-header"><a href="/w2025/modules/pwas/week3/3.2/#indexeddb-and-service-workers" class="sidebar-link">IndexedDB and Service Workers</a></li><li class="sidebar-sub-header"><a href="/w2025/modules/pwas/week3/3.2/#caching-strategies-for-service-workers" class="sidebar-link">Caching Strategies for Service Workers</a></li><li class="sidebar-sub-header"><a href="/w2025/modules/pwas/week3/3.2/#request-object-properties" class="sidebar-link">Request Object Properties</a></li><li class="sidebar-sub-header"><a href="/w2025/modules/pwas/week3/3.2/#online-and-offline" class="sidebar-link">Online and Offline</a></li><li class="sidebar-sub-header"><a href="/w2025/modules/pwas/week3/3.2/#fetch-event-handling" class="sidebar-link">Fetch Event Handling</a></li><li class="sidebar-sub-header"><a href="/w2025/modules/pwas/week3/3.2/#response-objects" class="sidebar-link">Response Objects</a></li><li class="sidebar-sub-header"><a href="/w2025/modules/pwas/week3/3.2/#opaque-responses" class="sidebar-link">Opaque Responses</a></li><li class="sidebar-sub-header"><a href="/w2025/modules/pwas/week3/3.2/#custom-responses" class="sidebar-link">Custom Responses</a></li><li class="sidebar-sub-header"><a href="/w2025/modules/pwas/week3/3.2/#controllerchange-vs-ready-property" class="sidebar-link">ControllerChange vs ready Property</a></li><li class="sidebar-sub-header"><a href="/w2025/modules/pwas/week3/3.2/#todo-this-week" class="sidebar-link">ToDo This Week</a></li></ul></li><li><a href="/w2025/modules/pwas/week4/4.1/" class="sidebar-link">4.1: Messaging</a></li><li><a href="/w2025/modules/pwas/week4/4.2/" class="sidebar-link">4.2: Intro to PWAs</a></li><li><a href="/w2025/modules/pwas/week5/5.1/" class="sidebar-link">5.1: PWAs Continued</a></li><li><a href="/w2025/modules/pwas/week5/5.2/" class="sidebar-link">5.2: IndexedDB &amp; Data</a></li><li><a href="/w2025/modules/pwas/week6/6.1/" class="sidebar-link">6.1: Hosting Projects</a></li><li><a href="/w2025/modules/pwas/week6/6.2/" class="sidebar-link">6.2: PWA Project</a></li><li><a href="/w2025/modules/pwas/week7/7.1/" class="sidebar-link">7.1: Git Pull Requests</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><header><div class="section-title red">
    PWA
  </div> <h1>3.2 Service Worker Events</h1> <div class="underdev no">Module Still Under Development</div></header> <h2 id="fetch-api-and-service-workers"><a href="#fetch-api-and-service-workers" class="header-anchor">#</a> Fetch API And Service Workers</h2> <p>By far, the most important thing you will do with a service worker is to make it work as a proxy server. A proxy server is a program that sits between your browser's webpage and the actual webserver that is sending the files. It has the ability to cache files for later use, manage when new versions of the file are needed, cache data in localStorage or an indexedDB, and basically provide an offline experience for the website.</p> <p>The first step is to add an event listener for the <code>fetch</code> event. This event is triggered <strong>EVERY</strong> time the browser sends a request for a file. Every request triggers this event. An HTML file, a css file, an image, a JS file, a JSON file, an API call, a font, or any kind of file.</p> <p>Inside the fetch event will be a Request object, which is the Request being sent from the browser. Now, our service worker gets to decide how to handle that request.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//this function runs on every request from the browser.</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//the event object contains a request property that is a Request Object.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Request" target="_blank" rel="noopener noreferrer">MDN reference for Request Objects<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Response" target="_blank" rel="noopener noreferrer">MDN reference for Response Objects<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>The <code>Request</code> object will contain a <code>url</code> property with the full URL of the Request, a <code>method</code> property that tells us if it was a <code>GET</code>, <code>POST</code>, <code>PUT</code>, <code>PATCH</code>, <code>DELETE</code>, <code>HEAD</code>, or <code>OPTIONS</code>
request, plus a <code>mode</code> property that tells us if the request was <code>cors</code>, <code>no-cors</code>, <code>same-origin</code>, or <code>navigate</code>. The <code>navigate</code> mode can be an important distinction. The user might be trying to leave
the website or navigate to a different page within our site. The other modes have to do with downloading files that will be used within our page.</p> <p>There is also a <code>headers</code> property that contains important meta information about the request. These might be needed to make requests to the actual Server. The <code>headers</code> can include things like the
<code>content-type</code> of the file being requested.</p> <p>Once we have the request we have many options.</p> <ol><li>Search the cache and return the file found there.</li> <li>Search the cache and if no matching file, do a fetch request for the file.</li> <li>Only forward the request on to the actual server and return a file from the server.</li> <li>Search the cache, return a file from there, and also forward the request to the server to get a new version of the requested file.</li> <li>Check if the user is online or offline and return different files based on the result.</li></ol> <p>These options are commonly referred to as <strong>caching strategies</strong>.</p> <p>To send anything back to the browser we would use the <code>respondWith()</code> method that can be found on the <code>fetch</code> event. The <code>respondWith()</code> method needs to be passed a <code>Response</code> object or a <code>Promise</code>
that resolves to a <code>Response</code> object.</p> <p>Here are a few examples demonstrating this.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ev<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// a response object you build</span>

ev<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>requestObj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//a match from a cache</span>

ev<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//a response from a server</span>

ev<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token comment">/* build a response object */</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

ev<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//an async function which returns a Promise</span>
  <span class="token comment">//just make sure that the function returns a Response Object</span>
  <span class="token comment">//to be wrapped by the Promise.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>You can also wrap the <code>ev.respondWith</code> calls inside of switch or if statements. The <code>self.addEventListener('fetch', (ev){})</code> can have a variety of <code>respondWith</code> calls. Only one of them will actually
execute.</p> <p>Here is a simple example showing a couple options.</p> <blockquote><p>Only the first <code>ev.respondWith()</code> call will actually run.</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//1. just forward the request to the actual server and back to the browser</span>
  ev<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//2. check the cache</span>
  <span class="token comment">// return the file from the cache if it exists</span>
  <span class="token comment">// if not, do a fetch, add to the cache and return to browser the fetched file</span>
  <span class="token comment">// remember to handle a failed fetch to the server</span>
  <span class="token comment">// pay attention to the nested `return` statements</span>
  ev<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>
    caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cacheResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>
        cacheResponse <span class="token operator">||</span>
        <span class="token function">fetch</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fetchResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//if the fetch fails...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fetchResponse<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">//return any failed fetch to the browser if you want</span>
              <span class="token keyword">return</span> fetchResponse<span class="token punctuation">;</span>
              <span class="token comment">//or throw an error and handle it in custom ways</span>
              <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>fetchResponse<span class="token punctuation">.</span>statusText<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//we have a file from the server</span>
            <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'mycache'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">,</span> fetchResponse<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">//we have to make a copy of the response to put it in the cache</span>
              <span class="token comment">//then return the file to the browser</span>
              <span class="token keyword">return</span> fetchResponse<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//had an error fetching the file</span>
            <span class="token comment">//what do you want to return to the browser request???</span>

            <span class="token comment">//a failed response?</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">488</span><span class="token punctuation">,</span> <span class="token literal-property property">statusText</span><span class="token operator">:</span> <span class="token string">'wtf'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//a custom response?</span>
            <span class="token keyword">let</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'bob'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token punctuation">[</span>json<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'data.json'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'application/json'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token literal-property property">statusText</span><span class="token operator">:</span> <span class="token string">'Ok'</span><span class="token punctuation">,</span> headers <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//a 404 error file from the cache?</span>
            <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'/404.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//end of ev.respondWith()</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h3 id="headers-of-requests-and-responses"><a href="#headers-of-requests-and-responses" class="header-anchor">#</a> Headers of Requests and Responses</h3> <p>If you are using the <code>ev.request.headers</code> object to figure out what kind of request you are dealing with, then you can use its <code>get()</code> method to read any header.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ev<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//would return the value of the `content-type` header in the request object.</span>
cacheMatch<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//would return the value of the Response object that was returned from the Cache.</span>
<span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//would return the value of the Response object that was returned by the fetch</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Not all servers will return a <code>Content-Type</code> header. Sometimes this can be a permission issue or a CORS issue. We might have an error that prevents access to the content because the Response object has a status code of <code>0</code>. An HTTP Status code of zero means that you have an Opaque Response. This is a response that does not have the needed permissions for JavaScript to access the content of the Response but it could still be a resource that could be used on the HTML page through things like a <code>&lt;img&gt;</code>, <code>&lt;video&gt;</code>, <code>&lt;audio&gt;</code>, or <code>&lt;link&gt;</code> element.</p> <blockquote><p>An HTTP status code of zero or a Response that is missing a <code>content-type</code> header is still the result of making a fetch call that actually communicated with a server.</p></blockquote> <p>If you are writing code inside of a Service Worker and you make a fetch call that returns an opaque response, that response can still be copied and saved in the Cache, and it can still be forwarded to the webpage to be displayed by the HTML. The only thing you can't do with an opaque response is read or use it in your JavaScript.</p> <h3 id="online-and-offline-in-the-service-worker"><a href="#online-and-offline-in-the-service-worker" class="header-anchor">#</a> Online and Offline in the Service Worker</h3> <p>When you need to check if the browser is currently offline, you should do it in the Service Worker the same way you would in your main script. Both your main script and the Service Worker can independently check if the browser is online.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//assume that we are online</span>
<span class="token comment">//a failed fetch will tell us that we were unable to reach the server...aka offline</span>
<span class="token keyword">let</span> online <span class="token operator">=</span> <span class="token string">'isOnline'</span> <span class="token keyword">in</span> navigator <span class="token operator">?</span> navigator<span class="token punctuation">.</span>isOnline <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>With the <code>navigator.isOnline</code> property we can tell if we are completely offline. It is also possible that the user is online but has a terrible connection. In these cases, a <code>fetch()</code> call will fail and trigger the <code>catch()</code> method. A <code>fetch()</code> call can timeout if it takes too long over the terrible connection.</p> <p>If we are using the <code>NetworkError</code> inside the first <code>fetch(url).then()</code> method then the <code>Error</code> that happens when the <code>fetch</code> is unable to reach the server will just be a standard <code>Error</code> object. This is a good way to differentiate.</p> <h3 id="nested-promises-and-returns"><a href="#nested-promises-and-returns" class="header-anchor">#</a> Nested Promises and returns</h3> <p>Inside the <code>ev.respondWith()</code> method we need to return a Promise object that contains a Response object. Sometimes this can lead to a series of nested <code>return</code> statements.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//ev.request is the HTTP Request from the browser</span>
  ev<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>
    caches
      <span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cacheResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> cacheResponse<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">fetch</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">let</span> type <span class="token operator">=</span> resp<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">let</span> path <span class="token operator">=</span> url<span class="token punctuation">.</span>pathname<span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NetworkError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to fetch </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">//at this point you might want to save the fetched response in the cache</span>
              <span class="token comment">//you need to return the call to caches.open()</span>
              <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">//create a copy of the fetched response to save in the cache</span>
                cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">,</span> resp<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//then return the response</span>
                <span class="token keyword">return</span> response<span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token comment">//handle the failure of the fetch</span>
              <span class="token comment">//check for Error vs NetworkError</span>
              <span class="token comment">//we should still return a Response object</span>
              <span class="token comment">//maybe an alternative item from the cache...</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//handle the error for the caches.match()</span>
        <span class="token comment">//we should still return a Response object</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h3 id="cache-put-vs-add"><a href="#cache-put-vs-add" class="header-anchor">#</a> Cache put() vs add()</h3> <p>A <code>cache</code> object has a <code>put(request, response)</code> and a <code>add(request)</code> method. Both will save a file <code>Response</code> to the <code>Cache</code>. The difference between them is that the <code>put</code> method <strong>ONLY</strong> saves a <code>Response</code> to the <code>Cache</code> using the <code>Request</code> as the key. The <code>add</code> method will make an HTTP request to the server to get the file and then save the <code>Response</code> in the <code>Cache</code>. If you already have a <code>Response</code> object then use the <code>put</code> method.</p> <div title="handling errors in promises" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/LzlGL3k3p04" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; fullscreen" allowfullscreen="allowfullscreen"></iframe></div> <div title="try catch throw" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/_am9rKw4vWw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; fullscreen" allowfullscreen="allowfullscreen"></iframe></div> <div title="Building Custom Promise-based Functions" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/rmrIl603zVM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; fullscreen" allowfullscreen="allowfullscreen"></iframe></div> <h2 id="caches-and-service-workers"><a href="#caches-and-service-workers" class="header-anchor">#</a> Caches and Service Workers</h2> <p>Service Workers can access caches the same way that a regular script would. Service Workers typically use caches to save files that will be used to cache data files fetched from the server as well as saving files that can be used if the web app is offline and can't access the server.</p> <p>With a Service Worker we have the <code>install</code>, <code>activate</code>, and <code>fetch</code> events. We do different things with the Cache from inside each of these events.</p> <p><strong>install event</strong> - This is the time to add an array of files to the cache that will be needed if offline.</p> <p><strong>activate event</strong> - This is the time to delete older versions of the cache that are no longer needed.</p> <p><strong>fetch event</strong> - This is the time to add a single file to the cache, if there is an updated version of the file, or if you want to save a new file that was not previously in the cache.</p> <p>For any of these to work we need to first get a reference to the cache with <code>caches.open(cacheName)</code>. This returns a Promise that contains the reference to the cache with the specified name.</p> <p>In the <code>fetch</code> listener function we are handling files, one at a time. For each file you will have to make decisions by looking at the file name, looking at the headers, checking the the current online|offline status and more.</p> <p>The <code>fetch</code> event object has a <code>request</code> property. This is a <code>Request</code> object like any other. It has a <code>url</code> property and a <code>headers</code> property.</p> <p>Inside the listener function we will check in the cache for files by passing a <code>Request</code> object or a url string to a <code>caches.match()</code> method. We can use <code>caches</code> because we are going to search through all current cache objects.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cacheMatch</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//the cacheMatch variable is a Response object that came out of the cache</span>
  <span class="token comment">//it matched whatever Request object was in the event object.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>If there is no match in the Cache for <code>ev.request</code> then the cacheMatch object will contain <code>null</code>. You can use this to decide if you want to return a match from the cache or if you need to do a <code>fetch()</code> call.</p> <p>The video below is an examination of how the Cache API can be used in connection with Service Workers.</p> <div title="From the Service Worker playlist - Cache API" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/Gu0t2EW2kfU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; fullscreen" allowfullscreen="allowfullscreen"></iframe></div> <p>This second video is how to use the caches from inside a Service Worker to keep things in sync with the Service Worker Life Cycle.</p> <div title="From the Service Worker playlist - Cache API &amp; Service Worker" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/ZoucFUOHGhk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; fullscreen" allowfullscreen="allowfullscreen"></iframe></div> <h2 id="indexeddb-and-service-workers"><a href="#indexeddb-and-service-workers" class="header-anchor">#</a> IndexedDB and Service Workers</h2> <p>If you want to learn about using a local document database in the browser, there is a built-in one called <code>IndexedDB</code>. We will look at <code>IndexedDB</code> in more detail in week 5, but here is a brief overview.</p> <p><code>IndexedDB</code> is a JSON-like database that you create in your browser and can use to store local information, similar to what you do with LocalStorage. The difference between IndexedDB and LocalStorage is that IndexedDB can hold more data and your script can search through the data and modify it. With IndexedDB, you don't have to download all the data and parse it before searching through the data for values or to modify or delete parts of the data.</p> <p><a href="https://www.youtube.com/watch?v=6fK1K28eoUA&amp;list=PLyuRouwmQCjmNyAysdqjNz5fIS5cYU4vi" target="_blank" rel="noopener noreferrer">Here is a full playlist of videos about how to use IndexedDB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>This is the first video in that playlist:</p> <div title="IndexedDB Part 1 Intro" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/gb5ovg7YCig" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; fullscreen" allowfullscreen="allowfullscreen"></iframe></div> <div title="From the Service Worker playlist - Integrating IndexedDB" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/4NkDiGd0mWc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; fullscreen" allowfullscreen="allowfullscreen"></iframe></div> <h2 id="caching-strategies-for-service-workers"><a href="#caching-strategies-for-service-workers" class="header-anchor">#</a> Caching Strategies for Service Workers</h2> <p>There are a number of basic strategies that are fairly standard for any website. You can also create your own more specific ones for any app that you build.</p> <p>Regardless of which strategy that you like to use, there will never be a single strategy that you use for every request on any website.</p> <p>You can create a single function for each strategy for easy reuse.</p> <p>Then, inside the <code>fetch</code> event listener function you will gather a bunch of values like the request file name, request file type, whether the browser is online, etc. Using those values, you create a series of nested if statements and call the appropriate cache strategy function for each condition.</p> <h3 id="cache-only"><a href="#cache-only" class="header-anchor">#</a> Cache Only</h3> <p>This strategy is used when you only want to send a response from a Cache, no network requests involved.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">cacheOnly</span><span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//only the response from the cache</span>
  <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="cache-first"><a href="#cache-first" class="header-anchor">#</a> Cache First</h3> <p>This strategy is used when you want to check the cache first and then only make a network request if the cache request fails.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">cacheFirst</span><span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//try cache then fetch</span>
  <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cacheResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> cacheResponse <span class="token operator">||</span> <span class="token function">fetch</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="network-only"><a href="#network-only" class="header-anchor">#</a> Network Only</h3> <p>This strategy is used when you only want to make fetch requests and you want to ignore the cache entirely.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">networkOnly</span><span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//only the result of a fetch</span>
  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="network-first"><a href="#network-first" class="header-anchor">#</a> Network First</h3> <p>This strategy is used when you want to make fetch requests but fall back on the cache if that fails.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">networkFirst</span><span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//try fetch then cache</span>
  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>status <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>response<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="stale-while-revalidate"><a href="#stale-while-revalidate" class="header-anchor">#</a> Stale While Revalidate</h3> <p>This strategy involves using both the cache and the network. The user is sent the copy in the cache if it exists. Then, regardless of whether or not the request exists in the cache, a fetch request is made. The new fetch response is saved in the cache to be ready for the next request.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">staleWhileRevalidate</span><span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//return cache then fetch and save latest fetch</span>
  <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cacheResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> fetchResponse <span class="token operator">=</span> <span class="token function">fetch</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> cacheResponse <span class="token operator">||</span> fetchResponse<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="network-first-and-revalidate"><a href="#network-first-and-revalidate" class="header-anchor">#</a> Network First And Revalidate</h3> <p>This strategy is similar to the Stale While Revalidate strategy except it prioritizes the fetch request over the current value in the cache.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">networkFirstAndRevalidate</span><span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//attempt fetch and cache result too</span>
  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>status <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>response<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//accept opaque responses with status code 0</span>
    <span class="token comment">//still save a copy</span>
    <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> response<span class="token punctuation">;</span> <span class="token comment">//send the fetch response to the web page/script</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="request-object-properties"><a href="#request-object-properties" class="header-anchor">#</a> Request Object Properties</h2> <p>When you want to select a different strategy for each file you need to have information about each Request in order to make those decisions.</p> <p>The <code>ev.request</code> object that we get from the Fetch Event contains lots of information that we can use for decision making.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> mode <span class="token operator">=</span> ev<span class="token punctuation">.</span>request<span class="token punctuation">.</span>mode<span class="token punctuation">;</span> <span class="token comment">// navigate, cors, no-cors</span>
<span class="token keyword">let</span> method <span class="token operator">=</span> ev<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method<span class="token punctuation">;</span> <span class="token comment">//get the HTTP method</span>
<span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//turn the url string into a URL object</span>
<span class="token keyword">let</span> queryString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//turn query string into an Object</span>
<span class="token keyword">let</span> isOnline <span class="token operator">=</span> navigator<span class="token punctuation">.</span>onLine<span class="token punctuation">;</span> <span class="token comment">//determine if the browser is currently offline</span>
<span class="token keyword">let</span> isImage <span class="token operator">=</span>
  url<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'.png'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
  url<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'.jpg'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
  url<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'.svg'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
  url<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'.gif'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
  url<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'.webp'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
  url<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'.jpeg'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
  url<span class="token punctuation">.</span>hostname<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'some.external.image.site'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//check file extension or location</span>
<span class="token keyword">let</span> selfLocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//determine if the requested file is from the same origin as your website</span>
<span class="token keyword">let</span> isRemote <span class="token operator">=</span> selfLocation<span class="token punctuation">.</span>origin <span class="token operator">!==</span> url<span class="token punctuation">.</span>origin<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="online-and-offline"><a href="#online-and-offline" class="header-anchor">#</a> Online and Offline</h2> <p>When you want to check if the browser is online or offline, the <code>navigator.onLine</code> property tells you absolutely if you are offline. The online value being true can be deceptive. So, it would be
better to also do a test. Pick an endpoint that you know always works efficiently and do a fetch call with the <code>HEAD</code> method. If that returns successfully, then you are definitely online.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">isConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//can only be called from INSIDE an ev.respondWith()</span>
  <span class="token keyword">const</span> maxWait <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span> <span class="token comment">//if it takes more than x milliseconds</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>navigator<span class="token punctuation">.</span>onLine<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//immediate response if offline</span>
  <span class="token comment">//exit if already known to be offline</span>
  <span class="token keyword">let</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token string">'https://jsonplaceholder.typicode.com/users/1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'HEAD'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> t1 <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> t2 <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> timeDiff <span class="token operator">=</span> t2 <span class="token operator">-</span> t1<span class="token punctuation">;</span>
      <span class="token comment">// console.log({ timeDiff });</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>ok <span class="token operator">||</span> timeDiff <span class="token operator">&gt;</span> maxWait<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">//true if navigator online and the HEAD request worked</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//the fetch failed or the response was not valid</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>You can also add a timer to that response. If you don't get a <code>HEAD</code> response quickly then you have a poor connection.</p> <p><strong>REMEMBER</strong> to add a URL that you trust to this Request.</p> <p>You might be able to save a few milliseconds by adding a preconnect in your HTML head with the same domain.</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>preconnect<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://jsonplaceholder.typicode.com<span class="token punctuation">&quot;</span></span> <span class="token attr-name">crossorigin</span> <span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>You can optionally restrict the <code>maxWait</code> value to a lower number of milliseconds. Exceeding this value when calculating the difference between two <code>performance.now()</code> calls means that you can also
treat slow connections as offline too.</p> <p><code>performance.now()</code> gives you an accurate number of milliseconds since the service worker started running. Call this before and after your <code>HEAD</code> fetch and it will tell you how long it took.</p> <p>If you want to use this method, remember that it can only be called from INSIDE a <code>ev.respondWith( )</code>. You need to make it the first step in a chain of .then( ).then( ) calls. Remember to return at
each level of nesting.</p> <p>In the sample version of <code>sw.js</code> this is being demonstrated inside the <code>networkFirstCred</code> function.</p> <p>You can <a href="https://developer.mozilla.org/en-US/docs/Web/API/Performance" target="_blank" rel="noopener noreferrer">read more about High Performance TimeStamps on MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="fetch-event-handling"><a href="#fetch-event-handling" class="header-anchor">#</a> Fetch Event Handling</h2> <p>Inside the fetch event listener function you will likely have many if statements, switch case statements, nested if statements, and logical short-circuiting.</p> <p>Treat the <code>respondWith()</code> method calls like function <code>return</code> statements. The first one that is encountered will send back the Response. However, the code in your function will continue to run after
it is called. So, always have an <code>else{ }</code> block. Don't make two <code>respondWith</code> calls in the same block.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> isOnline <span class="token operator">=</span> navigator<span class="token punctuation">.</span>onLine<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isOnline<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ev<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><span class="token function">fetchOnly</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    ev<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><span class="token function">cacheOnly</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="response-objects"><a href="#response-objects" class="header-anchor">#</a> Response Objects</h2> <p>There will also be times where you want to look at the <code>Response</code> object. You might want to check its headers and return different things depending on those values.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">fetch</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> hasType <span class="token operator">=</span> response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> type <span class="token operator">=</span> response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> size <span class="token operator">=</span> response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'content-length'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Headers/has" target="_blank" rel="noopener noreferrer">MDN Headers Object reference<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="opaque-responses"><a href="#opaque-responses" class="header-anchor">#</a> Opaque Responses</h2> <p>Sometimes, when you are making fetch calls you will get an <code>Opaque</code> response. This is a valid response but one that cannot be read by JavaScript. You cannot use JavaScript to get the values of the headers or call <code>.text()</code> or <code>.json()</code> or <code>.blob()</code> on. This happens when you are making a cross-origin request. Eg: trying to get an image file from a website that is not your own.</p> <p>The way to avoid some security issues with HTTP Request is to stop credentials and identifying information from being passed to the external web server. We do this by setting the <code>credentials</code> setting on the request to <code>omit</code>. This will prevent the information being sent and solve some of the errors that you see with external requests.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//ev.request is the request coming from the web page</span>
  <span class="token comment">//we can change its settings when making a fetch( ) call</span>
  ev<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">'omit'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>There are times when an <code>Opaque</code> response is not a problem. If the Request has a <code>destination</code> property set to <code>image</code> then we have no issue. The HTML is allowed to load and use items like images or fonts when they are <code>Opaque</code>. It is the JavaScript that is not allowed to use <code>Opaque</code> responses.</p> <p>To close this potential loop hole, You are not allowed to set the value of the <code>destination</code> header from JavaScript. Only the browser can set it. The destination property of the <code>Request</code> may be <code>audio</code>, <code>audioworklet</code>, <code>document</code>, <code>embed</code>, <code>font</code>, <code>frame</code>, <code>iframe</code>, <code>image</code>, <code>manifest</code>, <code>object</code>, <code>paintworklet</code>, <code>report</code>, <code>script</code>, <code>sharedworker</code>, <code>style</code>, <code>track</code>, <code>video</code>, <code>worker</code> or <code>xslt</code> strings, or the empty string, which is the default value.</p> <p>If the destination is blank then the request is coming from a <code>fetch()</code> call in your script, Cache request, beacons, WebSockets, or a few other things.</p> <p>The blank response or a response whose destination is <code>script</code> or <code>*-worklet</code> or <code>*-worker</code> will have tighter CORS restrictions.</p> <p>You can also change SOME of the other settings like <code>Headers</code> in the Request before it is sent to the server.</p> <h2 id="custom-responses"><a href="#custom-responses" class="header-anchor">#</a> Custom Responses</h2> <p>There are common things that happen in lots of web apps. Having a custom HTML page that we display when missing a page or having a placeholder image that we use. We can create our own functions for handling these things.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">placeholderImage</span><span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//return a specific placeholder image from the cache</span>
  <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'./404.png'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Html404</span><span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//return a 404 html file from the cache</span>
  <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'./404.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">fakeServerError</span><span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//pretend to have a server-side error</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'&lt;html&gt;&lt;body&gt;&lt;h1&gt;Server Gone Crazy&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">555</span><span class="token punctuation">,</span>
    <span class="token literal-property property">statusText</span><span class="token operator">:</span> <span class="token string">'Server Gone Crazy'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">fakeClientError</span><span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//if there are specific types of client errors that we want to create</span>
  <span class="token comment">//with our own selected HTTP Status codes, we can do that too</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'Custom text error message'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">477</span><span class="token punctuation">,</span>
    <span class="token literal-property property">statusText</span><span class="token operator">:</span> <span class="token string">'Custom Reason'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/plain'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>If you have a custom 404 page or a placeholder image that you want to use, then you need to put those in the cache when calling <code>cache.addAll</code> in your <code>install</code> event.</p> <h2 id="controllerchange-vs-ready-property"><a href="#controllerchange-vs-ready-property" class="header-anchor">#</a> ControllerChange vs ready Property</h2> <p>In some of the videos and code samples you will see reference to using a <code>controller</code> object to send messages and listening for the <code>controllerchange</code> event. Consider this the older approach.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//old approach</span>
navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'controllerchange'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//this means that there has been a change in which service worker is controlling the webpage</span>
  <span class="token comment">//and you now need to change to the new controller to be able to send messages</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>The better approach for sending a message, from the main script to the service worker, is to use the <code>ready</code> property to get the current active service worker and send the message. The <code>ready</code> property is a Promise. So, you can chain a <code>then()</code> method on to it which will call a function as soon as there is any available active service worker. The <code>registration</code> object will be passed to the then function.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//recommended approach to sending a message to a service worker</span>
<span class="token keyword">function</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>ready<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//we have access to the active service worker - reg.active</span>
    reg<span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>This is the recommended approach to sending a message from the main script to the service worker. More about Messaging next week in Module 4.1.</p> <h2 id="todo-this-week"><a href="#todo-this-week" class="header-anchor">#</a> ToDo This Week</h2> <div class="custom-block danger"><p class="custom-block-title">To Do this week</p> <ul><li>read all the content for modules 3.1 and 3.2</li> <li>read all the content for Hybrid <a href="/w2025/modules/hybrids/">web component creation</a></li> <li>start working on the <a href="/w2025/modules/hybrids/exercises.html">Hybrid web component Exercise</a></li></ul></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/21/2025, 3:31:04 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/w2025/modules/pwas/week3/3.1/" class="prev">
        3.1: Workers &amp; Service Workers
      </a></span> <span class="next"><a href="/w2025/modules/pwas/week4/4.1/">
        4.1: Messaging
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/w2025/assets/js/app.87c858a9.js" defer></script><script src="/w2025/assets/js/2.ccdb61a5.js" defer></script><script src="/w2025/assets/js/35.ab1290f2.js" defer></script><script src="/w2025/assets/js/9.01890ce5.js" defer></script><script src="/w2025/assets/js/11.5fe5a40b.js" defer></script>
  </body>
</html>
